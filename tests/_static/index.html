<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <script src="https://cdn.jsdelivr.net/npm/autobahn-js-built@0.11.1/autobahn.min.js"></script>
    <title>Game Worker Service Testing Page</title>
</head>
<body>

<header>
    <h1>Hello <span id="login">anonymus</span></h1>
</header>

<fieldset>
    <legend>Wamp Connection</legend>
    <input type="text" id="wamp-address" name="wamp-address" value="wamp-router:9000"/>
    <button id="connector">Connect to wamp</button>
</fieldset>

<fieldset>
    <legend>Game creation</legend>
    <input type="number" id="number-of-rows" name="number-of-rows"/>
    <input type="number" id="number-of-cols" name="number-of-cols"/>
    <label for="cell-type-hex">hex</label><input type="radio" id="cell-type-hex" name="cell-type" value="hex"/>
    <label for="cell-type-square">square</label><input type="radio" id="cell-type-square" name="cell-type"
                                                       value="square"/>
    <button id="create-game">Create game</button>
</fieldset>

<section id="games">

</section>
</body>
<script>
    document.getElementById("connector").onclick = () => {
        let wampAddress = document.getElementById("wamp-address").value;

        let connection = new autobahn.Connection({
            url: `ws://${wampAddress}/`,
            realm: 'hexammon',
            authmethods: ['jwt'],
            onchallenge: function (session, method, extra) {
                if (method === 'jwt') {
                    // you could also return a promise here
                    return 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdXRoaWQiOiJwbGF5ZXIiLCJhdXRocm9sZXMiOlsicGxheWVyIl19.wCvVkIg648cjX7sxrqHv2VL2fjeSRWEMsYegUI6SI10';
                }
            }
        });

        connection.onopen = function (session, details) {
            document.getElementById("login").innerText = details.authid;

            document.getElementById("create-game").onclick = () => {
                let playersIds = [1, 2];
                let gameParams = [
                    playersIds,
                    document.querySelector('input[name="cell-type"]:checked').value,
                    document.getElementById("number-of-rows").value,
                    document.getElementById("number-of-cols").value,
                ];
                session.call('net.hexammon.game.create', gameParams).then(
                    (result) => {
                        console.log(result);
                    },
                    (error) => {
                        console.error(error);
                    },
                    (progress) => {
                        console.debug(progress);
                    },
                )
            }
        };

        connection.onclose = function (reason, details) {
            console.log("Connection close: " + reason);
        };

        connection.open();
    };
</script>
</html>