<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <script src="https://cdn.jsdelivr.net/npm/autobahn-js-built@0.11.1/autobahn.min.js"></script>
    <title>Game Worker Service Testing Page</title>
</head>
<body>

<header>
    <h1>Hello <span id="login">Wamp Dispatcher</span></h1>
</header>

<fieldset>
    <legend>Wamp Connection</legend>
    <input type="text" id="wamp-address" name="wamp-address" value="wamp-router:9000"/>
    <button id="connector">Connect to wamp</button>
</fieldset>

<fieldset>
    <legend>Game creation</legend>
    <label for="players">Players</label><select multiple id="players" name="players">
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
</select>
    <div>
        <label for="number-of-rows">Number of rows</label> <input type="number" id="number-of-rows"
                                                                  name="number-of-rows"/>
    </div>
    <div>
        <label for="number-of-cols">Number of cols</label> <input type="number" id="number-of-cols"
                                                                  name="number-of-cols"/>
    </div>
    <div>
        <label for="cell-type-hex">hex</label><input type="radio" id="cell-type-hex" name="cell-type" value="hex"/>
    </div>
    <div>
        <label for="cell-type-square">square</label><input type="radio" id="cell-type-square" name="cell-type"
                                                           value="square"/>
    </div>
    <div>
        <button id="create-game">Create game</button>
    </div>
</fieldset>


<section>
    <button id="show-games">Show games</button>
    <ul id="games">

    </ul>
</section>
</body>
<script>
    document.getElementById("connector").onclick = () => {
        let wampAddress = document.getElementById("wamp-address").value;

        let connection = new autobahn.Connection({
            url: `ws://${wampAddress}/`,
            realm: 'hexammon',
            authmethods: ['jwt'],
            onchallenge: function (session, method, extra) {
                if (method === 'jwt') {
                    // you could also return a promise here
                    return 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdXRoaWQiOiJnYW1lLWRpc3BhdGNoZXIiLCJhdXRocm9sZXMiOlsiZ2FtZV9kaXNwYXRjaGVyIl19.Jq9pvhwK29OL5iNiYdxjV8CH2SaN41VFdWECLRwOac0';
                }
            }
        });

        connection.onopen = function (session, details) {
            document.getElementById("login").innerText = details.authid;

            document.getElementById("create-game").onclick = () => {
                let players = document.getElementById("players");
                let playersIds = [...players.querySelectorAll(":checked")].map((value) => {
                    return value.value;
                });
                let gameParams = [
                    playersIds,
                    document.querySelector('input[name="cell-type"]:checked').value,
                    document.getElementById("number-of-rows").value,
                    document.getElementById("number-of-cols").value,
                ];
                session.call('net.hexammon.game.create', gameParams).then(
                    (result) => {
                        console.log(result);
                    },
                    (error) => {
                        console.error(error);
                    },
                    (progress) => {
                        console.debug(progress);
                    },
                )
            }

            document.getElementById("show-games").onclick = () => {

                let gamesList = document.getElementById("games");
                let newGameItem = gamesList.createElement("li");
                gamesList.appendChild(newGameItem);
            }
        };

        connection.onclose = function (reason, details) {
            console.log("Connection close: " + reason);
        };

        connection.open();
    };
</script>
</html>